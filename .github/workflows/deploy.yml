name: Deploy

on:
  push:
    branches: [main]

# Prevent concurrent deploys
concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  # CI must pass before deploying
  ci:
    uses: ./.github/workflows/ci.yml

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: ci
    environment: production

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd ${{ secrets.SERVER_DEPLOY_PATH }}

            echo ">>> Pulling latest code..."
            git pull origin main

            echo ">>> Building and restarting containers..."
            docker compose up -d --build --force-recreate

            echo ">>> Cleaning up old images..."
            docker image prune -f

            echo ">>> Waiting for health check..."
            sleep 15

            echo ">>> Verifying API is running..."
            curl -f http://localhost:3333/docs || (echo "HEALTH CHECK FAILED" && exit 1)

            echo ">>> Deploy completed successfully!"
